(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6239],{1676:(e,s,a)=>{"use strict";a.d(s,{j:()=>i});var t=a(9941),l=a(73181),n=a(93673);function i(e,s){let{years:a=0,months:i=0,weeks:r=0,days:c=0,hours:o=0,minutes:u=0,seconds:d=0}=s,h=(0,l.a)(e,i+12*a),m=(0,t.e)(h,c+7*r);return(0,n.w)(e,m.getTime()-1e3*(d+60*(u+60*o)))}},9941:(e,s,a)=>{"use strict";a.d(s,{e:()=>l});var t=a(32078);function l(e,s){return(0,t.f)(e,-s)}},13310:(e,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>S});var t=a(95155),l=a(12115),n=a(34818),i=a(3998),r=a(86948),c=a(65142),o=a(76444),u=a(11186),d=a(92033),h=a(84336),m=a(13630),p=a(22452),x=a(94979),j=a(52619),f=a.n(j),v=a(58353),g=a(15894),w=a(20063),b=a(19708),N=a(18332),y=a(1676),C=a(15319),A=a(1554),k=a(99470),D=a(41048),M=a(50916);function S(){let e=(0,w.useRouter)(),s=(0,w.useParams)().id,{toast:a}=(0,g.dj)(),{user:j,isUserLoading:S}=(0,A.Jd)(),E=(0,A.jt)(),F=(0,A.$e)(()=>j?(0,b.H9)(E,"users/".concat(j.uid,"/workflows/").concat(s)):null,[E,j,s]),{data:P,isLoading:q}=(0,k.u)(F),J=(0,A.$e)(()=>j?(0,b.rJ)(E,"users/".concat(j.uid,"/patients")):null,[E,j]),{data:$,isLoading:_}=(0,D.G)(J),T=(0,A.$e)(()=>j?(0,b.rJ)(E,"users/".concat(j.uid,"/messageTemplates")):null,[E,j]),{data:L,isLoading:I}=(0,D.G)(T),[V,G]=(0,l.useState)(""),[O,z]=(0,l.useState)([]),[B,H]=(0,l.useState)([]),R=(0,l.useMemo)(()=>(null==P?void 0:P.patients)||[],[P]);(0,l.useEffect)(()=>{P&&(G(P.title),z(P.patients),H(P.steps.map(e=>({...e,schedule:{quantity:e.schedule.quantity||1,unit:e.schedule.unit||"days",event:e.schedule.event||"before"}}))))},[P]);let W=(0,l.useMemo)(()=>$?$.map(e=>({value:e.id,label:e.name})):[],[$]),Q=(0,l.useMemo)(()=>L?L.map(e=>({value:e.id,label:e.title})):[],[L]),X=(0,l.useMemo)(()=>O.filter(e=>!R.includes(e)),[O,R]),Y=(e,s,a,t)=>{let l=(0,b.rJ)(E,"users/".concat(e,"/scheduledMessages"));t.steps.forEach(n=>{let i;i=("before"===n.schedule.event?y.j:C.W)(a,{[n.schedule.unit]:n.schedule.quantity});let r={userId:e,patientId:s,templateId:n.template,workflowId:t.id,scheduledTime:b.Dc.fromDate(i),status:"Agendado"};(0,M.BH)(l,r)})},Z=async()=>{if(!j||!E||!$||!P)return;let e=0,s=0,t=new Map($.map(e=>[e.id,e])),l=(0,b.rJ)(E,"users/".concat(j.uid,"/scheduledMessages"));for(let a of X){let n=t.get(a);if(n)if(n.nextAppointment&&n.nextAppointment.toDate()>new Date){let s=n.nextAppointment.toDate(),t=(0,b.P)(l,(0,b._M)("patientId","==",a),(0,b._M)("workflowId","==",P.id),(0,b._M)("status","==","Agendado"));(await (0,b.GG)(t)).empty&&(Y(j.uid,a,s,P),e++)}else s++}a({title:"Envio Conclu\xeddo!",description:"Mensagens foram agendadas para ".concat(e," novo(s) paciente(s).")}),s>0&&a({variant:"destructive",title:"Aviso de Dados",description:"".concat(s," paciente(s) no fluxo est\xe3o sem data de pr\xf3xima consulta e foram ignorados.")})},K=(e,s,a)=>{let t=[...B],l=t[e];if(s.includes("schedule.")){let e=s.split(".")[1];l.schedule&&(l.schedule[e]=a)}else l[s]=a;H(t)};return q||S||_||I?(0,t.jsx)("div",{className:"flex justify-center items-center h-full",children:(0,t.jsx)(d.A,{className:"h-8 w-8 animate-spin text-primary"})}):P?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.z,{title:"Editar Fluxo: ".concat(P.title)}),(0,t.jsxs)(N.Fc,{className:"bg-blue-50 border-blue-200 text-blue-900 mb-8",children:[(0,t.jsx)(h.A,{className:"h-4 w-4 text-blue-600"}),(0,t.jsx)(N.XL,{className:"font-bold text-blue-800",children:"Dicas Importantes"}),(0,t.jsxs)(N.TN,{className:"space-y-1 mt-2",children:[(0,t.jsxs)("p",{children:["• Os fluxos s\xe3o acionados pela data em ",(0,t.jsx)("strong",{children:'"Pr\xf3xima Consulta"'})," no cadastro do paciente. Pacientes sem essa data ser\xe3o ignorados."]}),(0,t.jsx)("p",{children:'• A op\xe7\xe3o "Enviar Agora" em um fluxo existente aplicar\xe1 as regras apenas para pacientes que j\xe1 t\xeam uma pr\xf3xima consulta agendada.'}),(0,t.jsxs)("p",{children:["• Se adicionar um novo paciente a um fluxo, use o bot\xe3o ",(0,t.jsx)("strong",{children:'"Enviar para X novo(s)"'})," para agendar as mensagens para ele."]})]})]}),(0,t.jsxs)(r.Zp,{children:[(0,t.jsxs)(r.aR,{children:[(0,t.jsx)(r.ZB,{children:"Configura\xe7\xe3o do Fluxo"}),(0,t.jsx)(r.BT,{children:"Ajuste as regras de envio para esta automa\xe7\xe3o."})]}),(0,t.jsxs)(r.Wu,{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(o.J,{htmlFor:"workflow-name",children:"Nome do Fluxo"}),(0,t.jsx)(c.p,{id:"workflow-name",placeholder:"Ex: Lembretes de Retorno",value:V,onChange:e=>G(e.target.value)})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(o.J,{htmlFor:"patient-group",children:"Para quais pacientes?"}),(0,t.jsx)(v.K,{options:W,onValueChange:z,defaultValue:O,placeholder:"Selecione os pacientes"})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)(o.J,{children:"Passos do Fluxo"}),B.map((e,s)=>{var a,l,n;return(0,t.jsxs)("div",{className:"border p-4 rounded-lg space-y-4 relative",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center",children:[(0,t.jsxs)("h4",{className:"font-semibold",children:["Passo ",s+1]}),(0,t.jsx)(i.$,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-destructive",onClick:()=>{H(B.filter((e,a)=>a!==s))},children:(0,t.jsx)(m.A,{className:"h-4 w-4"})})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(o.J,{htmlFor:"template-".concat(s),children:"Template"}),(0,t.jsxs)(u.l6,{value:e.template,onValueChange:e=>K(s,"template",e),children:[(0,t.jsx)(u.bq,{id:"template-".concat(s),children:(0,t.jsx)(u.yv,{placeholder:"Selecione um template"})}),(0,t.jsx)(u.gC,{children:Q.map(e=>(0,t.jsx)(u.eb,{value:e.value,children:e.label},e.value))})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(o.J,{children:"Quando enviar?"}),(0,t.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,t.jsx)("span",{children:"Enviar"}),(0,t.jsx)(c.p,{type:"number",value:null==(a=e.schedule)?void 0:a.quantity,onChange:e=>K(s,"schedule.quantity",parseInt(e.target.value)),className:"w-16"}),(0,t.jsxs)(u.l6,{value:null==(l=e.schedule)?void 0:l.unit,onValueChange:e=>K(s,"schedule.unit",e),children:[(0,t.jsx)(u.bq,{className:"w-32",children:(0,t.jsx)(u.yv,{})}),(0,t.jsxs)(u.gC,{children:[(0,t.jsx)(u.eb,{value:"hours",children:"Horas"}),(0,t.jsx)(u.eb,{value:"days",children:"Dias"}),(0,t.jsx)(u.eb,{value:"weeks",children:"Semanas"}),(0,t.jsx)(u.eb,{value:"months",children:"Meses"})]})]}),(0,t.jsxs)(u.l6,{value:null==(n=e.schedule)?void 0:n.event,onValueChange:e=>K(s,"schedule.event",e),children:[(0,t.jsx)(u.bq,{className:"w-48",children:(0,t.jsx)(u.yv,{})}),(0,t.jsxs)(u.gC,{children:[(0,t.jsx)(u.eb,{value:"before",children:"Antes da consulta"}),(0,t.jsx)(u.eb,{value:"after",children:"Depois da consulta"})]})]})]})]})]},s)}),(0,t.jsxs)(i.$,{variant:"outline",className:"w-full",onClick:()=>{H([...B,{template:"",schedule:{quantity:1,unit:"days",event:"before"}}])},children:[(0,t.jsx)(p.A,{className:"mr-2 h-4 w-4"}),"Adicionar Passo"]})]})]}),(0,t.jsxs)(r.wL,{className:"flex justify-between",children:[(0,t.jsx)("div",{children:X.length>0&&(0,t.jsxs)(i.$,{onClick:Z,children:[(0,t.jsx)(x.A,{className:"mr-2 h-4 w-4"}),"Enviar para ",X.length," novo(s)"]})}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)(i.$,{variant:"outline",asChild:!0,children:(0,t.jsx)(f(),{href:"/workflows",children:"Cancelar"})}),(0,t.jsx)(i.$,{onClick:()=>{F&&((0,M.wu)(F,{title:V,patients:O,steps:B},{merge:!0}),a({title:"Fluxo salvo!",description:"Suas altera\xe7\xf5es no fluxo foram salvas com sucesso."}),e.push("/workflows"))},children:"Salvar Altera\xe7\xf5es"})]})]})]})]}):(0,t.jsx)("div",{children:"Fluxo n\xe3o encontrado."})}},15319:(e,s,a)=>{"use strict";a.d(s,{W:()=>r});var t=a(32078),l=a(41962),n=a(93673),i=a(43371);function r(e,s){let{years:a=0,months:r=0,weeks:c=0,days:o=0,hours:u=0,minutes:d=0,seconds:h=0}=s,m=(0,i.a)(e),p=r||a?(0,l.P)(m,r+12*a):m,x=o||c?(0,t.f)(p,o+7*c):p;return(0,n.w)(e,x.getTime()+1e3*(h+60*(d+60*u)))}},32078:(e,s,a)=>{"use strict";a.d(s,{f:()=>n});var t=a(43371),l=a(93673);function n(e,s){let a=(0,t.a)(e);return isNaN(s)?(0,l.w)(e,NaN):(s&&a.setDate(a.getDate()+s),a)}},41962:(e,s,a)=>{"use strict";a.d(s,{P:()=>n});var t=a(43371),l=a(93673);function n(e,s){let a=(0,t.a)(e);if(isNaN(s))return(0,l.w)(e,NaN);if(!s)return a;let n=a.getDate(),i=(0,l.w)(e,a.getTime());return(i.setMonth(a.getMonth()+s+1,0),n>=i.getDate())?i:(a.setFullYear(i.getFullYear(),i.getMonth(),n),a)}},43371:(e,s,a)=>{"use strict";function t(e){let s=Object.prototype.toString.call(e);return e instanceof Date||"object"==typeof e&&"[object Date]"===s?new e.constructor(+e):new Date("number"==typeof e||"[object Number]"===s||"string"==typeof e||"[object String]"===s?e:NaN)}a.d(s,{a:()=>t})},64227:(e,s,a)=>{Promise.resolve().then(a.bind(a,13310))},73181:(e,s,a)=>{"use strict";a.d(s,{a:()=>l});var t=a(41962);function l(e,s){return(0,t.P)(e,-s)}},93673:(e,s,a)=>{"use strict";function t(e,s){return e instanceof Date?new e.constructor(s):new Date(s)}a.d(s,{w:()=>t})},94979:(e,s,a)=>{"use strict";a.d(s,{A:()=>t});let t=(0,a(14294).A)("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]])},99470:(e,s,a)=>{"use strict";a.d(s,{u:()=>r});var t=a(12115),l=a(19708),n=a(9891),i=a(86501);function r(e){let[s,a]=(0,t.useState)(null),[r,c]=(0,t.useState)(!1),[o,u]=(0,t.useState)(null);return(0,t.useEffect)(()=>{if(!e){a(null),c(!1),u(null);return}c(!0),u(null);let s=(0,l.aQ)(e,e=>{e.exists()?a({...e.data(),id:e.id}):a(null),u(null),c(!1)},s=>{let t=new i.$({operation:"get",path:e.path});u(t),a(null),c(!1),n.d.emit("permission-error",t)});return()=>s()},[e]),{data:s,isLoading:r,error:o}}}},e=>{e.O(0,[2992,7138,7112,9251,1659,955,7353,531,9118,5308,4611,7356,2914,3491,7398,6117,8441,1255,7358],()=>e(e.s=64227)),_N_E=e.O()}]);