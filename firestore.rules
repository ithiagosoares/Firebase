rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      // O usuário que faz a requisição deve ser o dono do documento.
      function isOwner() {
        return request.auth.uid == userId;
      }

      // Permite a leitura do próprio perfil.
      allow get: if isOwner();

      // Nega a listagem de todos os usuários.
      allow list: if false;

      // Permite a CRIAÇÃO se:
      // 1. O usuário é o dono do documento.
      // 2. O 'id' e o 'email' nos dados enviados correspondem aos do usuário autenticado.
      // 3. O campo 'onboardingCompleted' está sendo definido como 'false'.
      // 4. O campo 'name' existe e é uma string.
      allow create: if isOwner() &&
                       request.resource.data.id == request.auth.uid &&
                       request.resource.data.email == request.auth.token.email &&
                       request.resource.data.onboardingCompleted == false &&
                       request.resource.data.name is string;

      // Permite a ATUALIZAÇÃO se:
      // 1. O usuário é o dono do documento.
      // 2. Ele NÃO está tentando alterar seu 'id' ou 'email'.
      allow update: if isOwner() &&
                       request.resource.data.id == resource.data.id &&
                       request.resource.data.email == resource.data.email;

      // Permite que o dono delete seu próprio perfil.
      allow delete: if isOwner();
    }

    // Regra para a coleção de Clínicas
    match /clinics/{clinicId} {
      // Permite que um usuário leia, crie ou atualize um documento de clínica
      // se o ID do documento for o mesmo que o ID do usuário autenticado.
      allow get, create, update: if request.auth.uid == clinicId;
    }

    match /users/{userId}/prompts/{promptId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

        function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    match /users/{userId}/generationConfigurations/{generationConfigurationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

        function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    match /users/{userId}/prompts/{promptId}/generatedContent/{generatedContentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    match /users/{userId}/scheduledMessages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}
